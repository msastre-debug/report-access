<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Access your childâ€™s report</title>
  <style>
    :root { --bg:#f6f7fb; --panel:#fff; --text:#222; --muted:#666; --brand:#1a73e8; --shadow:0 10px 30px rgba(0,0,0,.06); }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:560px;margin:8vh auto;background:var(--panel);border-radius:16px;box-shadow:var(--shadow);padding:24px}
    h2{margin:0 0 12px}
    label{display:block;margin:.75rem 0 .35rem}
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #dcdcdc;box-sizing:border-box;font-size:16px}
    button{margin-top:16px;padding:12px 16px;border:0;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-size:16px}
    .hint{color:var(--muted);font-size:14px;margin-top:8px}
    .msg{margin-top:12px;height:1.2em}
    .err{color:#b00020}
    .ok{color:#0a7a0a}
    .email{font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>View report</h2>
    <p class="hint">Enter the studentâ€™s <b>school email</b> and the <b>access code</b> we provided.</p>

    <label for="email">School email</label>
    <input id="email" type="email" placeholder="student@rafanadalschool.com" autocomplete="email"/>

    <label for="code">Access code</label>
    <input id="code" placeholder="e.g. AB12-3CD4" autocomplete="one-time-code"/>

    <button id="go">Open report</button>
    <div id="msg" class="msg"></div>

    <p class="hint">
      If you have any problems, please contact the school office or email
      <span class="email">msastre@rafanadalschool.com</span>.
    </p>
  </div>

  <script>
    // ðŸ”— REPLACE with your deployed Apps Script web app URL (the one ending in /exec)
    const BACKEND = 'https://script.google.com/macros/s/AKfycbw53pcPuT2SkI1-tEKn2YsYWFGb24lDsqNXeLmhpw_RgbCM7sTUEFE0IBaARKdFml7nOA/exec';

    const $ = sel => document.querySelector(sel);
    $('#go').addEventListener('click', go);
    $('#email').addEventListener('keydown', e => { if (e.key === 'Enter') go(); });
    $('#code').addEventListener('keydown',  e => { if (e.key === 'Enter') go(); });

    function setMsg(text, isErr=false){
      const el = $('#msg');
      el.className = 'msg ' + (isErr ? 'err' : 'ok');
      el.textContent = text || '';
    }

    // JSONP helper: create a temporary callback + <script> injection
    function jsonp(url, cb){
      const cbName = '__cb_' + Math.random().toString(36).slice(2);
      url += (url.includes('?') ? '&' : '?') + 'callback=' + cbName;

      const s = document.createElement('script');
      s.src = url;
      s.async = true;

      window[cbName] = function(data){
        try { cb(null, data); } finally {
          delete window[cbName];
          s.remove();
        }
      };

      s.onerror = () => {
        try { cb(new Error('Network error')); } finally {
          delete window[cbName];
          s.remove();
        }
      };

      document.body.appendChild(s);
    }

    function go(){
      const email = ($('#email').value || '').trim();
      const code  = ($('#code').value  || '').trim().toUpperCase();
      if(!email || !code){
        setMsg('Please enter both email and code.', true);
        return;
      }
      setMsg('Checkingâ€¦');

      const url = `${BACKEND}?action=validate&email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`;

      jsonp(url, (err, res) => {
        if(err){
          setMsg('Network error. Please try again.', true);
          return;
        }
        if(!res || !res.ok){
          setMsg((res && res.error) ? res.error : 'Unable to validate. Please try again.', true);
          return;
        }
        setMsg('Opening your reportâ€¦');
        // Open the Drive viewer link returned by backend
        window.location.href = res.url;
      });
    }
  </script>
</body>
</html>
